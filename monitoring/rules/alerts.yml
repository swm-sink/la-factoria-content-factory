groups:
  # API Availability Alerts
  - name: api_availability
    interval: 30s
    rules:
      - alert: APIDown
        expr: up{job="la-factoria-api"} == 0
        for: 1m
        labels:
          severity: critical
          service: api
        annotations:
          summary: "API is down"
          description: "La Factoria API has been down for more than 1 minute"

      - alert: HighErrorRate
        expr: |
          (
            sum(rate(http_requests_total{job="la-factoria-api",status=~"5.."}[5m]))
            /
            sum(rate(http_requests_total{job="la-factoria-api"}[5m]))
          ) > 0.05
        for: 5m
        labels:
          severity: critical
          service: api
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} for the last 5 minutes"

      - alert: APILatencyHigh
        expr: |
          histogram_quantile(0.95,
            sum(rate(http_request_duration_seconds_bucket{job="la-factoria-api"}[5m])) by (le)
          ) > 0.5
        for: 5m
        labels:
          severity: warning
          service: api
        annotations:
          summary: "API latency is high"
          description: "95th percentile latency is {{ $value }}s"

  # Content Generation Alerts
  - name: content_generation
    interval: 60s
    rules:
      - alert: ContentGenerationFailureRate
        expr: |
          (
            sum(rate(content_generation_total{status="error"}[10m]))
            /
            sum(rate(content_generation_total[10m]))
          ) > 0.05
        for: 10m
        labels:
          severity: warning
          service: content-generation
        annotations:
          summary: "High content generation failure rate"
          description: "Content generation failure rate is {{ $value | humanizePercentage }}"

      - alert: ContentGenerationSlow
        expr: |
          histogram_quantile(0.95,
            sum(rate(content_generation_duration_seconds_bucket[10m])) by (le)
          ) > 30
        for: 10m
        labels:
          severity: warning
          service: content-generation
        annotations:
          summary: "Content generation is slow"
          description: "95th percentile generation time is {{ $value }}s"

  # Database Alerts
  - name: database
    interval: 30s
    rules:
      - alert: DatabaseConnectionPoolExhausted
        expr: |
          (
            database_connections_active{job="la-factoria-api"}
            /
            database_connections_max{job="la-factoria-api"}
          ) > 0.9
        for: 5m
        labels:
          severity: critical
          service: database
        annotations:
          summary: "Database connection pool nearly exhausted"
          description: "{{ $labels.database }} connection pool is {{ $value | humanizePercentage }} full"

      - alert: DatabaseQuerySlow
        expr: |
          histogram_quantile(0.95,
            sum(rate(database_query_duration_seconds_bucket{job="la-factoria-api"}[5m])) by (le, operation)
          ) > 0.1
        for: 5m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "Database queries are slow"
          description: "{{ $labels.operation }} queries 95th percentile is {{ $value }}s"

  # Cache Alerts
  - name: cache
    interval: 30s
    rules:
      - alert: CacheHitRateLow
        expr: cache_hit_ratio{job="la-factoria-api"} < 0.8
        for: 10m
        labels:
          severity: warning
          service: cache
        annotations:
          summary: "Cache hit rate is low"
          description: "Cache hit rate is {{ $value | humanizePercentage }}"

  # External API Alerts
  - name: external_apis
    interval: 60s
    rules:
      - alert: ExternalAPIDown
        expr: |
          (
            sum(rate(external_api_requests_total{status="error"}[5m])) by (service)
            /
            sum(rate(external_api_requests_total[5m])) by (service)
          ) > 0.5
        for: 5m
        labels:
          severity: critical
          service: external-api
        annotations:
          summary: "External API {{ $labels.service }} is experiencing issues"
          description: "{{ $labels.service }} error rate is {{ $value | humanizePercentage }}"

      - alert: ExternalAPILatencyHigh
        expr: |
          histogram_quantile(0.95,
            sum(rate(external_api_duration_seconds_bucket[5m])) by (le, service)
          ) > 5
        for: 5m
        labels:
          severity: warning
          service: external-api
        annotations:
          summary: "External API {{ $labels.service }} is slow"
          description: "{{ $labels.service }} 95th percentile latency is {{ $value }}s"

  # System Alerts
  - name: system
    interval: 30s
    rules:
      - alert: HighMemoryUsage
        expr: |
          (
            node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes
          ) / node_memory_MemTotal_bytes > 0.9
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "High memory usage detected"
          description: "Memory usage is {{ $value | humanizePercentage }}"

      - alert: HighCPUUsage
        expr: |
          100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage is {{ $value }}%"

      - alert: DiskSpaceLow
        expr: |
          (
            node_filesystem_avail_bytes{mountpoint="/"}
            /
            node_filesystem_size_bytes{mountpoint="/"}
          ) < 0.1
        for: 5m
        labels:
          severity: critical
          service: system
        annotations:
          summary: "Low disk space"
          description: "Only {{ $value | humanizePercentage }} disk space remaining"

  # SLA Alerts
  - name: sla_monitoring
    interval: 60s
    rules:
      - alert: SLAViolation
        expr: sli_health_check_success_rate < 99.5
        for: 5m
        labels:
          severity: critical
          service: sla
          slo: availability
        annotations:
          summary: "SLA violation: API availability"
          description: "API availability is {{ $value }}%, below SLA target of 99.9%"

      - alert: ErrorBudgetBurnRateHigh
        expr: |
          (
            1 - sli_health_check_success_rate / 100
          ) > (1 - 0.999) * 2
        for: 5m
        labels:
          severity: warning
          service: sla
          slo: availability
        annotations:
          summary: "Error budget burn rate is high"
          description: "Burning error budget {{ $value }}x faster than normal"
