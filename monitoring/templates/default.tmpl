{{ define "__alertmanager" }}AlertManager{{ end }}
{{ define "__alertmanagerURL" }}{{ .ExternalURL }}/#/alerts?receiver={{ .Receiver | urlquery }}{{ end }}

{{ define "__subject" }}[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .GroupLabels.SortedPairs.Values | join " " }} {{ if gt (len .CommonLabels) (len .GroupLabels) }}({{ with .CommonLabels.Remove .GroupLabels.Names }}{{ .Values | join " " }}{{ end }}){{ end }}{{ end }}

{{ define "__description" }}{{ end }}

{{ define "__text_alert_list" }}{{ range . }}
{{ if .Labels.severity }}Severity: {{ .Labels.severity | toUpper }}{{ end }}
{{ if .Labels.service }}Service: {{ .Labels.service }}{{ end }}
{{ if .Labels.environment }}Environment: {{ .Labels.environment }}{{ end }}
Summary: {{ .Annotations.summary }}
Description: {{ .Annotations.description }}
{{ if .Labels.value }}Value: {{ .Labels.value }}{{ end }}
{{ if .Labels.threshold }}Threshold: {{ .Labels.threshold }}{{ end }}
Started: {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}
{{ if .EndsAt }}Ended: {{ .EndsAt.Format "2006-01-02 15:04:05 MST" }}{{ end }}
{{ if .Annotations.runbook_url }}Runbook: {{ .Annotations.runbook_url }}{{ end }}
{{ if .Annotations.dashboard_url }}Dashboard: {{ .Annotations.dashboard_url }}{{ end }}
{{ if .GeneratorURL }}Source: {{ .GeneratorURL }}{{ end }}
{{ end }}{{ end }}

{{ define "slack.default.title" }}{{ template "__subject" . }}{{ end }}
{{ define "slack.default.username" }}{{ template "__alertmanager" . }}{{ end }}
{{ define "slack.default.fallback" }}{{ template "slack.default.title" . }} | {{ template "slack.default.titlelink" . }}{{ end }}
{{ define "slack.default.pretext" }}{{ end }}
{{ define "slack.default.titlelink" }}{{ template "__alertmanagerURL" . }}{{ end }}
{{ define "slack.default.iconemoji" }}{{ end }}
{{ define "slack.default.iconurl" }}{{ end }}
{{ define "slack.default.text" }}{{ end }}

{{ define "pagerduty.default.description" }}{{ template "__subject" . }}{{ end }}
{{ define "pagerduty.default.client" }}La Factoria {{ template "__alertmanager" . }}{{ end }}
{{ define "pagerduty.default.clientURL" }}{{ template "__alertmanagerURL" . }}{{ end }}

{{ define "email.default.subject" }}{{ template "__subject" . }}{{ end }}
{{ define "email.default.html" }}
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta name="viewport" content="width=device-width" />
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>{{ template "__subject" . }}</title>
  <style>
    /* Global styles */
    * {
      margin: 0;
      padding: 0;
      font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif;
      box-sizing: border-box;
      font-size: 14px;
    }
    body {
      -webkit-font-smoothing: antialiased;
      -webkit-text-size-adjust: none;
      width: 100% !important;
      height: 100%;
      line-height: 1.6;
      background-color: #f6f6f6;
    }
    table td {
      vertical-align: top;
    }
    /* Main styles */
    .body-wrap {
      background-color: #f6f6f6;
      width: 100%;
    }
    .container {
      display: block !important;
      max-width: 600px !important;
      margin: 0 auto !important;
      clear: both !important;
    }
    .content {
      max-width: 600px;
      margin: 0 auto;
      display: block;
      padding: 20px;
    }
    .main {
      background: #fff;
      border: 1px solid #e9e9e9;
      border-radius: 3px;
    }
    .content-wrap {
      padding: 20px;
    }
    .content-block {
      padding: 0 0 20px;
    }
    .header {
      width: 100%;
      margin-bottom: 20px;
    }
    .alert {
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid transparent;
      border-radius: 4px;
    }
    .alert-critical {
      color: #721c24;
      background-color: #f8d7da;
      border-color: #f5c6cb;
    }
    .alert-high {
      color: #856404;
      background-color: #fff3cd;
      border-color: #ffeaa7;
    }
    .alert-warning {
      color: #004085;
      background-color: #cce5ff;
      border-color: #b8daff;
    }
    .alert-info {
      color: #0c5460;
      background-color: #d1ecf1;
      border-color: #bee5eb;
    }
    .btn {
      text-decoration: none;
      color: #FFF;
      background-color: #007bff;
      border: solid #007bff;
      border-width: 10px 20px;
      line-height: 2;
      font-weight: bold;
      text-align: center;
      cursor: pointer;
      display: inline-block;
      border-radius: 5px;
      text-transform: capitalize;
      margin: 0 5px;
    }
    .btn-primary {
      background-color: #007bff;
      border-color: #007bff;
    }
    .btn-secondary {
      background-color: #6c757d;
      border-color: #6c757d;
    }
  </style>
</head>
<body>
  <table class="body-wrap">
    <tr>
      <td></td>
      <td class="container" width="600">
        <div class="content">
          <table class="main" width="100%" cellpadding="0" cellspacing="0">
            <tr>
              <td class="content-wrap">
                <table width="100%" cellpadding="0" cellspacing="0">
                  <tr>
                    <td class="content-block">
                      <h2>La Factoria Alert</h2>
                    </td>
                  </tr>
                  <tr>
                    <td class="content-block">
                      {{ if gt (len .Alerts.Firing) 0 }}
                      <div class="alert alert-{{ (index .Alerts.Firing 0).Labels.severity }}">
                        <strong>{{ .Alerts.Firing | len }} alert{{ if gt (len .Alerts.Firing) 1 }}s{{ end }} firing</strong>
                      </div>
                      {{ range .Alerts.Firing }}
                      <h3>{{ .Labels.alertname }}</h3>
                      <p><strong>Summary:</strong> {{ .Annotations.summary }}</p>
                      <p><strong>Description:</strong> {{ .Annotations.description }}</p>
                      <p>
                        <strong>Details:</strong><br/>
                        Service: {{ .Labels.service }}<br/>
                        Environment: {{ .Labels.environment }}<br/>
                        Severity: {{ .Labels.severity }}<br/>
                        Started: {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}<br/>
                        {{ if .Labels.value }}Value: {{ .Labels.value }}<br/>{{ end }}
                        {{ if .Labels.threshold }}Threshold: {{ .Labels.threshold }}<br/>{{ end }}
                      </p>
                      <p>
                        {{ if .Annotations.runbook_url }}
                        <a href="{{ .Annotations.runbook_url }}" class="btn btn-primary">View Runbook</a>
                        {{ end }}
                        {{ if .Annotations.dashboard_url }}
                        <a href="{{ .Annotations.dashboard_url }}" class="btn btn-secondary">View Dashboard</a>
                        {{ end }}
                      </p>
                      <hr/>
                      {{ end }}
                      {{ end }}

                      {{ if gt (len .Alerts.Resolved) 0 }}
                      <div class="alert alert-info">
                        <strong>{{ .Alerts.Resolved | len }} alert{{ if gt (len .Alerts.Resolved) 1 }}s{{ end }} resolved</strong>
                      </div>
                      {{ range .Alerts.Resolved }}
                      <p>
                        <strong>{{ .Labels.alertname }}</strong> - {{ .Annotations.summary }}<br/>
                        Resolved at: {{ .EndsAt.Format "2006-01-02 15:04:05 MST" }}
                      </p>
                      {{ end }}
                      {{ end }}
                    </td>
                  </tr>
                  <tr>
                    <td class="content-block">
                      <a href="{{ .ExternalURL }}" class="btn btn-primary">View in AlertManager</a>
                    </td>
                  </tr>
                </table>
              </td>
            </tr>
          </table>
        </div>
      </td>
      <td></td>
    </tr>
  </table>
</body>
</html>
{{ end }}

{{ define "email.default.text" }}
La Factoria Alert

{{ if gt (len .Alerts.Firing) 0 }}
[FIRING:{{ .Alerts.Firing | len }}]
{{ template "__text_alert_list" .Alerts.Firing }}
{{ end }}

{{ if gt (len .Alerts.Resolved) 0 }}
[RESOLVED:{{ .Alerts.Resolved | len }}]
{{ template "__text_alert_list" .Alerts.Resolved }}
{{ end }}

View in AlertManager: {{ .ExternalURL }}
{{ end }}
